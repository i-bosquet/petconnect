version: '3.9'

services:
  # PostgreSQL Database Service
  db:
    image: postgres:17.4
    container_name: petconnect_db
    restart: unless-stopped # Restarts if stopped, unless we stop it manually
    environment:
      POSTGRES_DB: ${POSTGRES_DB} # Read from the .env file
      POSTGRES_USER: ${POSTGRES_USER} # Read from the .env file
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Read from the .env file
    volumes:
      - postgres_data:/var/lib/postgresql/data # Named volume for persistence
    ports:
     - "5432:5432"
    networks:
      - petconnect-network

#   Adminer Service (Graphical Interface for the Database)
  adminer:
    image: adminer
    container_name: petconnect_adminer
    restart: unless-stopped
    ports:
      - "8081:8080" # Map Adminer's internal port 8080 to 8081 on your host machine
    networks:
      - petconnect-network
    depends_on: # Ensures the database attempts to start first
      - db

  # Servicio Backend
#  backend:
#    container_name: petconnect_backend
#    # ... .
#    networks:
#      - petconnect-network
#    depends_on: # The backend needs the DB to be ready
#      - db

  # Servicio Frontend
#  frontend:
#    container_name: petconnect_frontend
#    # ...  ...
#    networks:
#      - petconnect-network
#    depends_on: # The backend needs the DB to be ready
#      - db

  # SonarQube Service
  sonarqube:
    image: sonarqube:latest
    container_name: petconnect_sonarqube
    restart: unless-stopped
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
      # Optional: Configure SonarQube to use your PostgreSQL instead of the embedded H2
      # - sonar.jdbc.url=jdbc:postgresql://db:5432/${POSTGRES_DB} # 'db' es el nombre del servicio postgres
      # - sonar.jdbc.username=${POSTGRES_USER}
      # - sonar.jdbc.password=${POSTGRES_PASSWORD}
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
      # - sonarqube_conf:/opt/sonarqube/conf # # Uncomment if you need to persist conf
    ports:
      - "9000:9000" # Port for the SonarQube web interface
    networks:
      - petconnect-network
    depends_on: # SonarQube is database dependent if you configure it to use Postgres
      - db # Remove if you use embedded H2

networks:
  petconnect-network:
    driver: bridge

# Defines the named volume for PostgreSQL data persistence
volumes:
  postgres_data:
    driver: local
  sonarqube_data:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_logs:
    driver: local
# sonarqube_conf: # Uncomment if you use the conf volume
#   driver: local